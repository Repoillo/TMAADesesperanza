<!DOCTYPE html>
<html lang="es">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMAA Pan</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://png.pngtree.com/png-vector/20240806/ourmid/pngtree-branding-with-warmth-bread-loaf-logos-for-your-bakery-png-image_13393835.png" type="image/png">
    <script src="carrito.js" defer></script>
</head>
<body>
    <header>
        <h1>Panader칤a Desesperanza 游游</h1> 
    </header>

    <div class="acciones-header">
        <a href="historial.html" class="btn-carrito-header" style="background-color: var(--cafe-oscuro);">
            Mis Pedidos
        </a>
        <a href="carrito.html" class="btn-carrito-header">
            游 Carrito
        </a>
        
        <button onclick="abrirModalCartera()" class="btn-cartera">
             Saldo: $<span id="saldo-header">...</span>
        </button>
    </div>
    <main class="productos">
        <section>
            <h2>Los normalitos</h2>
            <div class="productou" id="pnormal">
            </div>
        </section>
        <section class="spookyjeje">
            <h2>Temporada</h2>
            <div class="productou" id="pspooky">
            </div>
        </section>
        <br>
        <br>
        
        <button id="logout-btn" class="crudb btn-logout">Cerrar Sesi칩n de cliente</button>
        <div id="modal-cartera" class="modal-overlay">
            <div class="modal-content">
                <h2>Mi Billetera</h2>
                <p>Saldo Disponible:</p>
                <span class="saldo-grande">$<span id="saldo-modal">0.00</span></span>

                <p>Agregar fondos:</p>
                <input type="number" id="monto-deposito" class="input-dinero" placeholder="Ej. 500.00" min="1">

                <button onclick="depositarDinero()" class="btn-depositar">Depositar</button>
                <button onclick="cerrarModalCartera()" class="btn-cerrar-modal">Cancelar</button>
            </div>
        </div>

        <script src="cartera.js"></script>
    </main>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const logoutButton = document.getElementById('logout-btn');
        fetch('/api/productos-tienda', { credentials: 'include' }) 
            .then(res => {
                if (!res.ok) {
                    if (res.status === 401) {
                         window.location.href = 'index.html';
                         return;
                    }
                    throw new Error('No se pudieron cargar los productos');
                }
                return res.json();
            })
            .then(data => {
                const contenedorNormal = document.getElementById('pnormal');
                const contenedorSpooky = document.getElementById('pspooky');

                contenedorNormal.innerHTML = '';
                contenedorSpooky.innerHTML = '';

                data.forEach(prod => {
                    const productoDiv = document.createElement('div');
                    productoDiv.className = 'pan'; 
                    
                    if (prod.imagen_url) {
                        const imagenPan = document.createElement('img');
                        imagenPan.src = prod.imagen_url;
                        productoDiv.appendChild(imagenPan);
                    }
                    const nombrePan = document.createElement('h3');
                    nombrePan.textContent = prod.nombre;

                    const precioPan = document.createElement('p');
                    precioPan.className = 'precio'; 
                    precioPan.textContent = `$${parseFloat(prod.precio_venta).toFixed(2)}`;

                    productoDiv.appendChild(nombrePan);
                    productoDiv.appendChild(precioPan);

                    const botonA침adir = document.createElement('button');
                    botonA침adir.className = 'btn-add-cart';
                    botonA침adir.textContent = 'A침adir al carrito';
                    
                    botonA침adir.onclick = () => {
                        agregarAlCarrito(
                            prod.id_producto,
                            prod.nombre,
                            prod.precio_venta
                        );
                    };
                    
                    productoDiv.appendChild(botonA침adir);

                    if (prod.es_de_temporada == 1) {
                        contenedorSpooky.appendChild(productoDiv);
                    } else {
                        contenedorNormal.appendChild(productoDiv);
                    }
                });
            })
            .catch(err => {
                console.error(err);
                document.querySelector('.productos').innerHTML = '<p>Error al cargar productos.</p>';
            });
    if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include' 
                });

                if (response.ok) {
                    window.location.href = 'index.html'; 
                } else {
                    console.error('Error al cerrar sesi칩n:', await response.text());
                    alert('No se pudo cerrar la sesi칩n correctamente.');
                }
            } catch (error) {
                console.error('Error de red al cerrar sesi칩n:', error);
                alert('Error de conexi칩n. No se pudo contactar con el servidor.');
            }
        });
    }
    });
    
</script>
</body>
</html>